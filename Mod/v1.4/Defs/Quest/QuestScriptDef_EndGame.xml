<?xml version="1.0" encoding="UTF-8"?>
<Defs>
  <QuestScriptDef>
    <defName>VV_EndGame_Worldtree</defName>
    <isRootSpecial>true</isRootSpecial>
    <autoAccept>true</autoAccept>
    <endOnColonyMove>false</endOnColonyMove>
    <defaultChallengeRating>4</defaultChallengeRating>
    <questNameRules>
      <rulesStrings>
        <li>questName->the worldtree in legend</li>
      </rulesStrings>
    </questNameRules>
    <questDescriptionRules>
      <rulesStrings>
        <li>questDescription->.</li>
      </rulesStrings>
    </questDescriptionRules>
    
    <root Class="QuestNode_Sequence">
      <nodes>
        <li Class="QuestNode_QuestUnique">
          <tag>VV_EndGame_Worldtree</tag>
        </li>
        <li Class="VVRace.QuestNode_Root_Worldtree" />
      </nodes>
    </root>
  </QuestScriptDef>

  <!-- phase 1-->
  <QuestScriptDef>
    <defName>VV_EndGame_Worldtree_Step_Archaeologist</defName>
    <isRootSpecial>true</isRootSpecial>
    <autoAccept>false</autoAccept>
    <epicParent>VV_EndGame_Worldtree</epicParent>
    <defaultChallengeRating>4</defaultChallengeRating>
    <endOnColonyMove>false</endOnColonyMove>

    <questNameRules>
      <rulesStrings>
        <li>questName->ancient records</li>
      </rulesStrings>
    </questNameRules>

    <questDescriptionRules>
      <rulesStrings>
        <li>questDescription->[asker_faction_name]'s archaeologist, [asker_nameDef] is requesting. [commonMainPart]</li>
        <li>commonMainPart->Recently, having succeeded in hacking the Mechanoid network and gained various interesting facts, but since then, Mechanoid swarms have been dropping intermittently, attacking [asker_possessive] settlement.
        \n[asker_pronoun] wants to disrupt the Mechanoid signal to buy time for the settlement to recover and wishes to divert the threat. If you help, [asker_pronoun] promises to share the information has found, including records of a giant tree that existed in ancient times.
        \nIf you accept, the [enemyFaction_pawnsPlural] will arrive in [firstRaidDelayTicks_duration].</li>
      </rulesStrings>
    </questDescriptionRules>

    <root Class="QuestNode_Sequence">
      <nodes>
        <li Class="QuestNode_Set">
          <name>pointsFactor</name>
          <value>4.0</value>
        </li>
        <li Class="QuestNode_Multiply">
          <value1>$points</value1>
          <value2>$pointsFactor</value2>
          <storeAs>points</storeAs>
        </li>

        <li Class="QuestNode_GetMap" />
        <li Class="QuestNode_GetPawn">
          <storeAs>asker</storeAs>
          <canGeneratePawn>true</canGeneratePawn>
          <minTechLevel>Industrial</minTechLevel>
          <mustHaveNoFaction>false</mustHaveNoFaction>
          <allowPermanentEnemyFaction>false</allowPermanentEnemyFaction>
          <mustHaveRoyalTitleInCurrentFaction>true</mustHaveRoyalTitleInCurrentFaction>
          <hostileWeight>0.15</hostileWeight>
          <maxUsablePawnsToGenerate>100</maxUsablePawnsToGenerate>
        </li>

        <li Class="QuestNode_GetRandomInRangeInt">
          <storeAs>raidCount</storeAs>
          <range>1~1</range>
        </li>
        <li Class="QuestNode_Set">
          <name>firstRaidDelayTicks</name>
          <value>$(roundToTicksRough(randInt(2500, 30000)))</value>
        </li>
        <li Class="VVRace.QuestNode_FixedFaction">
          <factionDef>Mechanoid</factionDef>
          <storeAs>enemyFaction</storeAs>
        </li>
        
        <li Class="QuestNode_Delay">
          <delayTicks>$firstRaidDelayTicks</delayTicks>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_SubScript">
                <prefix>raid</prefix>
                <def>Util_Raid</def>
                <parms>
                  <tag>lord</tag>
                  <inSignal>$inSignal</inSignal>
                  <map>$map</map>
                  <enemyFaction>$enemyFaction</enemyFaction>
                  <points>$points</points>
                  <walkInSpot>$walkInSpot</walkInSpot>
                  <customLetterLabel>$customLetterLabel</customLetterLabel>
                  <customLetterText>$customLetterText</customLetterText>
                  <customLetterLabelRules>$customLetterLabelRules</customLetterLabelRules>
                  <customLetterTextRules>$customLetterTextRules</customLetterTextRules>
                </parms>
              </li>
            </nodes>
          </node>
        </li>

        <li Class="QuestNode_AllSignals">
          <inSignals>
            <li>raid/lord.AllEnemiesDefeated</li>
          </inSignals>
          <node Class="QuestNode_Delay">
            <delayTicks>300</delayTicks>
            <node Class="QuestNode_Sequence">
              <nodes>
                <li Class="VVRace.QuestNode_GiveRewardWorldtreeLocation" />
                <li Class="QuestNode_End">
                  <outcome>Success</outcome>
                </li>
              </nodes>
            </node>
          </node>
        </li>
      </nodes>
    </root>
  </QuestScriptDef>

  <!-- phase 2-->
  <QuestScriptDef>
    <defName>VV_EndGame_Worldtree_Step_AssaultComplex</defName>
    <isRootSpecial>true</isRootSpecial>
    <autoAccept>true</autoAccept>
    <epicParent>VV_EndGame_Worldtree</epicParent>
    <defaultChallengeRating>4</defaultChallengeRating>
    <endOnColonyMove>false</endOnColonyMove>
    <questNameRules>
      <rulesStrings>
        <li>questName->ancient worldtree location</li>
      </rulesStrings>
    </questNameRules>
    <questDescriptionRules>
      <rulesStrings>
        <li>questDescription->.</li>
      </rulesStrings>
    </questDescriptionRules>
    <questContentRules>
      <rulesStrings>
        <!-- Misc -->
        <li>terminalHackedMessage->You've hacked terminal and discovered secret information about worldtree! You can now leave.</li>
      </rulesStrings>
    </questContentRules>
    <root Class="VVRace.QuestNode_Root_Worldtree_MechanoidScoutingBase" />
  </QuestScriptDef>
  
  <!-- phase 3-->
  <QuestScriptDef>
    <defName>VV_EndGame_Worldtree_Step_RestoreWorldtree</defName>
    <isRootSpecial>true</isRootSpecial>
    <autoAccept>true</autoAccept>
    <epicParent>VV_EndGame_Worldtree</epicParent>
    <defaultChallengeRating>4</defaultChallengeRating>
    <endOnColonyMove>false</endOnColonyMove>

    <questNameRules>
      <rulesStrings>
        <li>questName->.</li>
      </rulesStrings>
    </questNameRules>
    <questDescriptionRules>
      <rulesStrings>
        <li>questDescription->.</li>
      </rulesStrings>
    </questDescriptionRules>

    <root Class="QuestNode_Sequence">
      <nodes>
        <!-- Add reward info -->
        <li Class="VVRace.QuestNode_AddCoronationReward">
          <inSignalChoiceUsed>worldtree.LaunchedShip</inSignalChoiceUsed>
        </li>
        
        <li Class="VVRace.QuestNode_Worldtree_FindWorldtreeTile">
          <storeAs>tile</storeAs>
        </li>
        <li Class="QuestNode_GenerateWorldObject">
          <def>VV_Worldtree</def>
          <storeAs>worldtree</storeAs>
        </li>
        <li Class="QuestNode_SpawnWorldObjects">
          <worldObjects>$worldtree</worldObjects>
          <tile>$tile</tile>
        </li>

        <!-- Ending -->
        
        <!-- World object destroyed -->
        <li Class="QuestNode_NoWorldObject">
          <worldObject>$worldtree</worldObject>
          <node Class="QuestNode_End">
            <outcome>Fail</outcome>
          </node>
        </li>
        
        <!-- Reactor destroyed -->
        <li Class="QuestNode_Signal">
          <inSignal>worldtree.ReactorDestroyed</inSignal>
          <node Class="QuestNode_End">
            <outcome>Fail</outcome>
          </node>
        </li>
        
        <!-- Launched ship -->
        <li Class="QuestNode_End">
          <inSignal>worldtree.LaunchedShip</inSignal>
          <outcome>Success</outcome>
        </li>
      </nodes>
    </root>
  </QuestScriptDef>
</Defs>